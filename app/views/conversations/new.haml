- content_for :javascript do
  initialize_send_message_form('#{I18n.locale}', '#{free_conversation? ? "free" : Listing.opposite_type(@listing.direction)}');

- binding.pry
- other_party = @conversation.other_party(@current_user)
- title = Maybe(@conversation).listing.title

.centered-section-wide
  .message-avatar-padding
    .row
      .col-12
        %h2
          = title.map { |title| link_to title, @conversation.listing }.or_else { t(".conversation_with", person: link_to(other_party.name, other_party)).html_safe }

        %p
          - if @conversation.status.eql?("free")
          - else
            = t(".requested_by", requester_name: link_to(@conversation.starter.name, @conversation.starter)).html_safe

        - Maybe(@conversation).listing.each do |listing|
          - price = Maybe(listing).price.or_else(nil)
          - sum = Maybe(@conversation).payment.total_sum.or_else(nil)

          - if sum
            %p.message-price
              = t(".sum", sum: humanized_money_with_symbol(sum))
          - elsif price
            %p.message-sum
              = t(".price", price: humanized_money_with_symbol(price))

              - if listing.quantity.present?
                = "/ #{listing.quantity}"

              - if @current_community.vat
                %span.message-sum-vat
                  = t(".price_excludes_vat")

          - if @conversation.status.eql?("free")
            - unless listing.author == @current_user
              = link_to reply_to_listing_path(:id => listing.id.to_s), :class => "message-book-button" do
                .content
                  = listing.transaction_type.action_button_label(I18n.locale)

          - else
            %div{:id => "conversation_#{@conversation.id.to_s}_status"}
              = render :partial => "status", :locals => { :conversation => @conversation }


/ #new_message_form.centered-section
/   - if free_conversation?
/     %h2= t(".send_message_to_user", :person => @target_person.given_name_or_username)
/   - elsif @listing.transaction_type.action_button_label(I18n.locale)
/     %h2
/       = @listing.transaction_type.action_button_label(I18n.locale)
/       = link_to(@listing.title, @listing)

/   %p
/     = t(".this_message_is_private", :person => @target_person.given_name_or_username)
/     - if free_conversation?
/       = t(".you_will_get_notified", :person => @target_person.given_name_or_username)
/     - else
/       = t(".you_will_get_notified_of_acceptance", :person => @target_person.given_name_or_username)
/   = form_for @conversation, :url => person_messages_path(:person_id => @current_user.id) do |form|

/     = fields_for "conversation[message_attributes]", Message.new do |message_form|
/       = message_form.label :content, t('.message')
/       = message_form.text_area :content, :class => "text_area"
/       = message_form.hidden_field :sender_id, :value => @current_user.id

/     = hidden_field_tag "conversation[conversation_participants][#{@current_user.id}]", true
/     = hidden_field_tag "conversation[conversation_participants][#{@target_person.id}]", false
/     - if @listing
/       = form.hidden_field :listing_id, :value => @listing.id
/     - if free_conversation?
/       = form.hidden_field :status, :value => "free"
/     - if params[:profile_message]
/       = hidden_field_tag "profile_message", params[:profile_message]
/       = hidden_field_tag "target_person_id", @target_person.id
/     - if params[:comment_message]
/       = hidden_field_tag "comment_message", params[:comment_message]
/       = hidden_field_tag :listing_id, @listing.id
/       = hidden_field_tag "target_person_id", @target_person.id
/     = form.hidden_field :community_id, :value => @current_community.id
/     = form.button t(".send_message"), :class => "send_button"
